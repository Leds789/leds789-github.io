### Overview

- Background information
	- History
	- Suspected Author
- Overview of analysis Tools
- Provision Lab
- Conduct Analysis
	- Download Zeus Banking Trojan
	- Label Malware (Hashes) & VirusTotal
	- Basic static Analysis
		- Host-based indicators
	- Basic Dynamic Analysis
		- Network Based indicators
	- Report & ICOs
		- Write a YARA rule


### What is Zeus

- [Zeus Museum](https://zeusmuseum.com/ )This websites purpose is to find, categorize and document every single version of these Zeus-derived families. 
- First spotted in 2007 when Zeus Trojan was caught stealing sensitive information from systems owned by the US department of Transportation. Since then, there have been 573+ known versions with 36 known families of the Zeus Trojan.
- Code become public in 2011 after first leak
- The suspected Author is A Russian dude, has a $3m bounty from the FBI and continues to be the most wanted hacker - [Darknet Diaries episode](https://www.youtube.com/watch?v=5NeTt2pAzkc)

#### Goal & delivery methods

##### Goal: 
- To steal peoples financial information to ex filtrate financial information. 
- Add machines to a globally distributed P2P botnet (Depends on the variant)
##### Delivery method:
- Drive-by downloads: requires a user to visit a website that has the backdoor Trojan code on it.
	- Moden web browsers block these downlaods by default
	- attack vector is mostly obsolete in these days
- Phishing & Spam Campaigns: Main infection method

##### Crackdown & impact

**Crackdown:
- FBI cracked down on Gameover Zeus (Prolific variant in 2014)
- An estimated 1 million computers were infected
- $100+ million in financial damages due to Gameover Zeus
- The author has a $3m bounty on his head, and continues to be one of the most wanted hackers. 

**Impact:
- Inspired hundreds of additional variants which use parts of the source code
- Millions of infected machines damaged

### Analysis Tools

##### VirusTotal
- Analus tools used to assess malicious files, domains, IP addresses, and URLs to detect malware
- Works by aggregating the results of antivirus products and online security scan engine. Outputs which engines have flagged a file as malicous or known threat
- Used to fingerprint a malicious sample and measure its functionality against established security engines
##### PeStudio
- Program used to statically analyze malware and identify artifacts of interest
- Collects static information
	- Hashes
	- File header
	- File properties
	- Strings
	- Libraries Used
	- Imports
- Easy to use program
##### Floss 
- Extracts strings from executables
- Uses advanced static analysis technique to automatically deobfuscate strings from malware binaries
```$> floss malicious.exe```

![[{68553C28-42A1-44A8-BE61-107307C5F004}.png]]
##### Capa
- Automatically detects capabilities of a program and outputs what it think the program can do 
- Rules are matched against known APO calls identified, strings of interest and more
- Behavior is mapped to the MITRE ATT&CK framework

```$> capa [-v] [-v] malicious.exe```
##### Cutter
- Reverse-engineering platform
- Used to view assembly-level instructions of program
- View decompiled code
##### INetSim
- Software suite used for simulating common internet services
- Can be used to analyze the network behavior for malware samples
- Supports simlation for many services
##### Wireshark
- Network packet sniffer and analyzer, 
- Malware Analysis use Cases
	- View ingress / egress network traffic from malicious programs
	- Flag domains or IP addresses being reached out to within the program.
##### Procmon
- Part of the Sysinternals Suite
- Monitors and displays real time info on the windows file system
- Captures events from different classes
	- Registry
	- Filesystem
	- Network
	- Processes
	- Profiling Events
- Used to capture malicious activity occuring on filesystem
#####  YARA
- Used to classify and idenity malware samples by creating "rules" of malware families based on textual of binary patterns
- YARA rules are written by defining variables with interesting strings and byte sequences. Variables are evaluated by the condition block, which implements the logic of where, how or when strings or byte sequences occur.
### Analysis of Zeus

Here is my analysis of Zeus Malware following the guide of [Grant Collins Youtube video](https://www.youtube.com/watch?v=rmSIm3BKu3Y&list=PLLDjng0_4bmMvtDw94WcyzpegCOMCs3MP&index=2). 
#### Fingerprint

- VirusTotal Output

- First we turned the internet back on, and uploaded the file to VirusTotal.com 
![[{27482545-651B-4869-A5ED-BFF63E1FACBD}.png]]
- This gave us information on providers who have reported and blocked this virus, its also given us the md5,sha1 and sha256 hashes

MD5
ea039a854d20d7734c5add48f1a51c34

SHA-1
9615dca4c0e46b8a39de5428af7db060399230b2

SHA-256
69e966e730557fde8fd84317cdef1ece00a8bb3470c0b58f3231e170168af169


FileName: invoice_2318362983713_823931342io.pdf.exe

- Is trying to imitate a pdf file but is a .exe
#### Basic Static Analysis

- We see a weird url pointing to corect.com which we will investigate later.
![[Pasted image 20241112165723.png]]
- We will now look under Directions (invalid) > sections (self-Modifying)
- We want to compare the file sizes. 
- If the virtual and raw sizes are similar it can indicate the files are compressed. 
- If they are different it will mean they are packed, the virtual size will be much bigger than the raw size in this case.
- In this case, we can assume its not packed.
![[Pasted image 20241112170138.png]]

- Next we go to Strings >
- We can see all the function calls.  If we sort by "Flagged" we see there is 18 flagged functions. 
![[Pasted image 20241112170628.png]]
![[Pasted image 20241112170910.png]]

- Then we go to the libraries tab, we can see the .dlls being used
![[{1E02F85C-01D9-460B-8D30-F96EA03AA0A9}.png]]
- Using Floss, a cli 
- we use line ```floss invoice_2318362983713_823931342io.pdf.exe > strings.txt``` 
- This gave a out put (the .txt file command we added) of strings. We will search this .txt file for any websites using common url endings like .com
- We only find the corect.com as we found before. 
- We use -n 6 to output the strings to be *above* 6 characters

- Using Capa, Powershell cli 
- Navigate to where file is, use ```capa file.name```
- This is another way to gather data on the file such as hashes. 
- Capa is unique because it maps to the MITRE ATT&CK
![[{45AE6DDE-F403-41D7-B04B-DBFA70FC4E70}.png]]
- ```capa -v``` Will give a more basic output
- ```capa -vv``` Will give information on where it thinks the capabilities are

- We used our host machine to look up corect.com on VirusTotal.com URL search. 
- No security engine flags this as malicious. 
![[{FC64315C-C9A1-4110-9546-DA8E68A7C0DF}.png]]
- We can use Waybackmachine. com to see the URL history. Go to year 2013 when this file was being used.
- On feb 16th 2013 it was a romanian news site. 
- Corect.com yeilded no useful information
###### API Calls
UpdateWindow
AllowSetForegroundWindow
IsWindowEnabled
CallWindowProc
CellrotoCrudUntohighCols
GetWindowTextLength
DeleteCriticalSection
GetClipboardOwner
GetClipboardData
EnumClipboardFormats
DdeQueryNextServer
GlobalAddAtom
SizeofResource
GetLogicalDrives
GetTickCount
GetEnvironmentVariable
GetDriveType
GetEnvironmentVariable
LocalUnlock
HeapFree
VirtualQueryEx
LocalAlloc
LocalFree
SwapMouseButton
VkKeyScan
GetAsyncKeyState
GetCapture
CopyAcceleratorTable
WriteFile
PathRenameExtension
PathQuoteSpaces
PathCombine
GetCompressedFileSize
CreateFileMapping
FindNextFile
GetCurrentThread
GetPrivateProfileInt
WinExec
FreeLibrary
GetModuleHandle
GetConsoleAliasExesLength
!This program cannot be run in DOS mode.
 

#### Advanced static analysis

- Use Cutter to Analyze the Assembly code
![[Pasted image 20241112190030.png]]

- We found this AllowSetForgroundWindow thats also in the API calls. 
- GetTickCount usually tells us how long a machine has been on 
![[{72C2707D-1CB2-43F4-9EFD-19DB267979CA}.png]]
- This GetTickcount and AllowSetForeGroundWindow could be a way of showing how long the machine has been on for.
- ![[Pasted image 20241112190656.png]]
- This is where the KERNELL32.CreateFileA is located but we arnt smart enough to know what this means yet
#### Basic Dynamic Analysis

- Ensuring network is set to Host only and connected to the remnux machine we opened procmon and run inetsim on the remnux
- Run the virus, it tries to connect to something, then deletes itself. Using procmon we can see the process tree that the invoice.exe is still running 
![[{6F02FD40-8BCD-4B50-BF40-B5F17455057C}.png]]
- On the Grant Collins video he has a InstallFlashPlayer.exe which mine did not execute. I checked if restoring the file and re running it would activate the flashplayer.exe but it appears it checks if the virus is already installed. 
- I followed the conhost.exe to the system32 drive. 
![[Pasted image 20241112192323.png]]
- conhost.exe could be used to open a backdoor console for the attacker
- Running it just opens cmd prompt
![[{71BD02A4-82AD-4992-8036-991F5C8E9114}.png]]
-

#### YARA Rule

![[Pasted image 20241112210925.png]]

- I created a basic YARA rule 
- I ran the YARA rule in Cmder using ```yara64 Zeus.yara.txt invoice_2318362983713_823931342io.pdf.exe -s -w -p 32```

